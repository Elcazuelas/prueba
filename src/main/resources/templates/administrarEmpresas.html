<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrar Empresas</title>
    <link rel="stylesheet" href="/css/listar.css">
    <link rel="icon" href="img/LogoCENS.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link
        href="https://cdn.datatables.net/v/dt/jq-3.7.0/jszip-3.10.1/dt-1.13.8/b-2.4.2/b-colvis-2.4.2/b-html5-2.4.2/datatables.min.css"
        rel="stylesheet">
</head>

<body>
    <!--BARRA DE NAVEGACION-->
    <div class="contenedor">
        <div class="navegadorL">
            <ul>
                <li>
                    <div class="logo">
                        <a th:href="@{/}">
                            <img src="/img/LogoCENS.png" alt="Logo Cens" height="100">
                        </a>
                    </div>
                </li>
                <li>
                    <a th:href="@{/}">
                        <span class="icono">
                            <ion-icon name="home-outline"></ion-icon>
                        </span>
                        <span class="titulo"> Inicio</span>
                    </a>
                </li>
                <li>
                    <a th:href="@{/admin}">
                        <span class="icono">
                            <ion-icon name="people-outline"></ion-icon>
                        </span>
                        <span class="titulo">Administrar Usuarios</span>
                    </a>
                </li>
                <li>
                    <a th:href="@{/misdatos}">
                        <span class="icono">
                            <ion-icon name="person-outline"></ion-icon>
                        </span>
                        <span class="titulo"> Mis Datos</span>
                    </a>
                </li>
                <li>
                    <a th:href="@{/logout}">
                        <span class="icono">
                            <ion-icon name="log-out-outline"></ion-icon>
                        </span>
                        <span class="titulo"> Cerrar Sesión</span>
                    </a>
                </li>
            </ul>
        </div>
    </div>

    <!--	--------------->

    <div class="cuerpo">
        <div class="encabezado">
            <div class="toggleicon">
                <ion-icon name="menu-outline"></ion-icon>
            </div>
        </div>
    </div>
    <div class="container emp-profile">
        <h3>Listado Empresas CENS</h3>
        <div class="d-flex justify-content-end">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">Agregar
                Empresa</button>
        </div>
        <br>
        <table id="tablaEmpresas" class="table">
            <thead>
                <tr>
                    <th>RUT</th>
                    <th>Nombre Empresa</th>
                    <th>Razón Social</th>
                    <th>Correo Empresa</th>
                    <th>Teléfono Empresa</th>
                    <th>Nombre Representante</th>
                    <th>Apellido Representante</th>
                    <th>Correo Representante</th>
                    <th>Teléfono Representante</th>
                    <th class="acciones-column">Acciones</th>
                </tr>
                <br>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>



    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Agregar Nueva Empresa</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Formulario para agregar una nueva empresa -->
                    <!-- Utiliza Thymeleaf para enlazar los campos del formulario con tu modelo de empresa -->
                    <!-- Asegúrate de incluir los campos necesarios y las validaciones que requieras -->
                    <form th:action="@{/guardarEmpresa}" method="post" th:object="${empresaDTO}">
                        <div class="mb-3">
                            <label for="rut_empresa" class="form-label">RUT:</label>
                            <input type="text" class="form-control" id="rut_empresa" name="rut_empresa" required>
                        </div>

                        <div class="mb-3">
                            <label for="nombre_empresa" class="form-label">Nombre de la Empresa:</label>
                            <input type="text" class="form-control" id="nombre_empresa" name="nombre_empresa" required>
                        </div>

                        <div class="mb-3">
                            <label for="razon_social" class="form-label">Razón Social:</label>
                            <input type="text" class="form-control" id="razon_social" name="razon_social" required>
                        </div>

                        <div class="mb-3">
                            <label for="correo_empresa" class="form-label">Correo de la Empresa:</label>
                            <input type="email" class="form-control" id="correo_empresa" name="correo_empresa" required>
                        </div>

                        <div class="mb-3">
                            <label for="telefono_empresa" class="form-label">Teléfono de la Empresa:</label>
                            <input type="text" class="form-control" id="telefono_empresa" name="telefono_empresa"
                                required>
                        </div>

                        <div class="mb-3">
                            <label for="nombre_representante" class="form-label">Nombre del Representante:</label>
                            <input type="text" class="form-control" id="nombre_representante"
                                name="nombre_representante" required>
                        </div>

                        <div class="mb-3">
                            <label for="apellido_representante" class="form-label">Apellido del
                                Representante:</label>
                            <input type="text" class="form-control" id="apellido_representante"
                                name="apellido_representante" required>
                        </div>

                        <div class="mb-3">
                            <label for="correo_representante" class="form-label">Correo del Representante:</label>
                            <input type="email" class="form-control" id="correo_representante"
                                name="correo_representante" required>
                        </div>

                        <div class="mb-3">
                            <label for="telefono_representante" class="form-label">Teléfono del
                                Representante:</label>
                            <input type="text" class="form-control" id="telefono_representante"
                                name="telefono_representante" required>
                        </div>

                        <!-- Botones del modal -->
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script
        src="https://cdn.datatables.net/v/dt/jq-3.7.0/jszip-3.10.1/dt-1.13.8/b-2.4.2/b-colvis-2.4.2/b-html5-2.4.2/datatables.min.js"></script>
    <script src="https://kit.fontawesome.com/d3d517335c.js" crossorigin="anonymous"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script>
        function formatearRun(rut_empresa) {
            rut_empresa = rut_empresa.replace(/\./g, '').replace(/-/g, '');

            if (!/^(\d{7,8})-?([\dkK])$/.test(rut_empresa)) {
                return "Formato de RUT inválido";
            }

            let numero = rut_empresa.slice(0, -1);
            let digitoVerificador = rut_empresa.slice(-1).toUpperCase();

            return numero.replace(/(\d)(?=(\d{3})+(\D|$))/g, "$1.") + "-" + digitoVerificador;
        }
        $(document).ready(function () {
            $('#tablaEmpresas').DataTable({
                "ajax": {
                    "url": "/listarEmpresas",
                    "dataSrc": ""
                },
                "language": {
                    "sProcessing": "Cargando...",
                    "sLengthMenu": "Mostrando _MENU_ resultados",
                    "sZeroRecords": "No se encontraron resultados",
                    "sEmptyTable": "No se encontraron resultados",
                    "sInfo": "Mostrando empresas del _START_ al _END_ de un total de _TOTAL_ empresas",
                    "sInfoEmpty": "Mostrando empresas del 0 al 0 de un total de 0 empresas",
                    "sInfoFiltered": "(filtrado de un total de _MAX_ empresas)",
                    "sInfoPostFix": "",
                    "sSearch": "Buscar:",
                    "sUrl": "",
                    "sInfoThousands": ",",
                    "sLoadingRecords": "Cargando...",
                    "oPaginate": {
                        "sFirst": "Primero",
                        "sLast": "Último",
                        "sNext": "Siguiente",
                        "sPrevious": "Anterior"
                    },
                    "oAria": {
                        "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
                        "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                    },
                },
                "order": [[1]],
                "columnDefs": [
                    { "orderable": false, "targets": [0, 1, 2, 3, 4, 5, 6, 7, 8, 9] } // Deshabilitar la ordenación para las demás columnas
                ],
                "pageLength": 10, // Longitud de página predeterminada
                "dom": 'Bfrtip',  // Agrega el contenedor de los botones al DOM
                "columns": [
                    {
                        "data": "rut_empresa",
                        "render": function (data, type, row) {
                            return formatearRun(data);  // Llama a la función formatearRun para formatear el RUN
                        }
                    },
                    { "data": "nombre_empresa" },
                    { "data": "razon_social" },
                    { "data": "correo_empresa" },
                    { "data": "telefono_empresa" },
                    { "data": "nombre_representante" },
                    { "data": "apellido_representante" },
                    { "data": "correo_representante" },
                    { "data": "telefono_representante" },
                    {
                        "data": null,
                        "render": function (data, type, row) {
                            return '<a href="/editarEmpresa/' + row.id + '" class="btn btn-warning" title="Editar"><i class="fas fa-pencil text-black" title="Editar"></i></a>' + '&nbsp;' +
                                '<button onclick="eliminar(' + row.id + ')" class="btn btn-danger" title="Eliminar"><i class="fas fa-trash-alt text-black" title="Eliminar"></i></button>';
                        }
                    }
                ],
                "buttons": [
                    {
                        extend: 'pdfHtml5',
                        exportOptions: {
                            columns: ':not(.acciones-column)' // Excluye las columnas con la clase 'acciones-column'
                        },
                        text: '<i class="fa-regular fa-file-pdf fa-lg" style="color: #ff0000;"></i> Exportar a PDF', // Agrega un icono de FontAwesome al texto
                        title: 'Listado Empresas',
                        pageMargins: [40, 60, 40, 60], // Establece los márgenes de la página (arriba, izquierda, abajo, derecha)
                        orientation: 'landscape'
                    },
                    {
                        extend: 'excelHtml5',
                        title: 'Listado Empresas',
                        text: '<i class="fa-regular fa-file-excel fa-lg" style="color: #00d13f;"></i> Exportar a Excel', // Agrega un icono de FontAwesome al texto del botón
                        exportOptions: {
                            columns: ':not(.acciones-column)' // Excluye las columnas con la clase 'acciones-column' al exportar a Excel
                        }
                    }
                ]
            });
        });
    </script>
    <script src="/javascript/lateralBar.js"></script>
    <script src="javascript/administrarEmpresas.js"></script>
</body>

</html>